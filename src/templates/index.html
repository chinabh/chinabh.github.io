<!DOCTYPE html>
<html lang="{{LANG}}" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO Meta Tags -->
    <title>{{META_TITLE}}</title>
    <meta name="description" content="{{META_DESCRIPTION}}">
    <meta name="keywords" content="{{META_KEYWORDS}}">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{META_TITLE}}">
    <meta property="og:description" content="{{META_DESCRIPTION}}">
    <meta property="og:image" content="{{OG_IMAGE}}">

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <!-- Styles -->
    <link rel="stylesheet" href="/assets/styles.css">

    <!-- Fonts - Self-hosted for China compatibility -->
    <style>
        /* Critical CSS for fast first paint */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Sans CJI SC"; line-height: 1.6; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    </style>
</head>
<body>
    <!-- PASSWORD PROTECTION OVERLAY (Remove on launch day) -->
    {{PASSWORD_PROTECTION}}
    <!-- END PASSWORD PROTECTION -->

    <!-- Floating Header -->
    <header class="floating-header" id="floating-header">
        <div class="header-container">
            <a href="#hero" class="header-logo">
                <img src="{{HEADER_LOGO}}" alt="{{HEADER_LOGO_ALT}}" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';" />
                <span style="display:none; font-size:1.2rem; font-weight:bold; color:#dc2626;">China Business Hub</span>
            </a>
            <nav class="header-nav">
                {{HEADER_BUTTONS}}
                <div class="lang-switcher">
                    <select id="language-selector" onchange="switchLanguage(this.value)">
                        {{LANGUAGE_OPTIONS}}
                    </select>
                </div>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="hero" class="hero" style="background-image: url('{{HERO_BG_IMAGE}}');">
        <div class="hero-overlay"></div>
        <div class="container hero-content">
            <div class="hero-title-wrapper">
                <h1 class="hero-title-zh">{{HERO_TITLE_ZH}}</h1>
                <div class="hero-title-separator"></div>
                <h2 class="hero-title-en">
                    <span class="hero-title-line1">{{HERO_TITLE_EN_LINE1}}</span>
                    <span class="hero-title-line2">{{HERO_TITLE_EN_LINE2}}</span>
                </h2>
            </div>
            <p class="hero-subtitle">{{HERO_SUBTITLE}}</p>

            <div class="hero-cta">
                <button class="btn btn-primary" onclick="scrollToSection('contact')">{{HERO_CTA_PRIMARY}}</button>
                <button class="btn btn-secondary" onclick="scrollToSection('process')">{{HERO_CTA_SECONDARY}}</button>
                <a href="{{HERO_CTA_TERTIARY_URL}}" class="btn btn-tertiary" target="_blank" rel="noopener noreferrer">{{HERO_CTA_TERTIARY}}</a>
            </div>

            {{TRUST_BADGES}}

            {{CANTON_BANNER}}
        </div>
    </section>

    <!-- Services Section -->
    <section id="services" class="services section section-alt">
        <div class="container">
            <h2 class="section-title">{{SERVICES_TITLE}}</h2>

            <div class="services-grid">
                {{SERVICES_ITEMS}}
            </div>
        </div>
    </section>

    <!-- Process Section -->
    <section id="process" class="process section">
        <div class="container">
            <h2 class="section-title">{{PROCESS_TITLE}}</h2>

            <div class="process-steps">
                {{PROCESS_STEPS}}
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="about section">
        <div class="container">
            <h2 class="section-title">{{ABOUT_TITLE}}</h2>

            <div class="about-grid">
                <div class="about-card">
                    <h3>{{MISSION_TITLE}}</h3>
                    <p>{{MISSION_CONTENT}}</p>
                </div>

                <div class="about-card">
                    <h3>{{VISION_TITLE}}</h3>
                    <p>{{VISION_CONTENT}}</p>
                </div>
            </div>

            {{GUANXI_SECTION}}
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" class="contact section section-alt">
        <div class="container">
            <h2 class="section-title">{{CONTACT_TITLE}}</h2>
            <p class="section-subtitle">{{CONTACT_SUBTITLE}}</p>

            <div class="contact-wrapper">
                <!-- Contact Form -->
                <div class="contact-form-container">
                    <form id="contact-form" class="contact-form" action="{{FORM_ACTION}}" method="{{FORM_METHOD}}" onsubmit="return handleFormSubmit(event)">
                        {{FORM_FIELDS}}

                        <!-- Hidden fields for tracking -->
                        <input type="hidden" name="language" value="{{LANG}}">
                        <input type="hidden" name="_subject" value="New Contact from China Business Hub ({{LANG_NAME}})">
                        <input type="hidden" name="_page_url" id="_page_url">
                        <input type="hidden" name="_user_agent" id="_user_agent">

                        <!-- Honeypot for spam protection -->
                        <input type="text" name="_gotcha" style="display:none" tabindex="-1" autocomplete="off">

                        <button type="submit" class="btn btn-primary btn-block" id="submit-btn">
                            {{FORM_SUBMIT_TEXT}}
                        </button>
                    </form>

                    <!-- Success/Error Messages -->
                    <div id="form-success" class="alert alert-success" style="display:none;">
                        {{SUCCESS_MESSAGE}}
                    </div>
                    <div id="form-error" class="alert alert-error" style="display:none;">
                        {{ERROR_MESSAGE}}
                    </div>
                </div>

                <!-- Contact Info -->
                <div class="contact-info">
                    <div class="contact-methods">
                        {{CONTACT_METHODS}}
                    </div>

                    {{WECHAT_QR}}
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-links">
                {{FOOTER_LINKS}}
            </div>
            <div class="footer-copyright">
                {{FOOTER_COPYRIGHT}}
            </div>
        </div>
    </footer>

    {{WHATSAPP_BUTTON}}

    <!-- Scripts -->
    <script>
        // Set tracking fields
        document.getElementById('_page_url').value = window.location.href;
        document.getElementById('_user_agent').value = navigator.userAgent;

        // Add UTM parameters if present
        const urlParams = new URLSearchParams(window.location.search);
        ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
            if (urlParams.has(param)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = param;
                input.value = urlParams.get(param);
                document.getElementById('contact-form').appendChild(input);
            }
        });

        // Smooth scroll
        function scrollToSection(id) {
            const element = document.getElementById(id.replace('#', ''));
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Language switcher
        function switchLanguage(lang) {
            const currentPath = window.location.pathname;
            let newPath = '/';

            if (lang === 'en') newPath = '/';
            else if (lang === 'zh') newPath = '/zh/';

            window.location.href = newPath;
        }

        // REDUNDANT FORM SUBMISSION WITH BACKUP
        // Submits to both Cloudflare Worker + Formspree for reliability
        async function handleFormSubmit(event) {
            event.preventDefault(); // Prevent default form submission

            const form = event.target;
            const submitBtn = document.getElementById('submit-btn');
            const successMsg = document.getElementById('form-success');
            const errorMsg = document.getElementById('form-error');

            // Clear previous messages
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            // Validate required fields
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#dc2626';
                    isValid = false;
                } else {
                    field.style.borderColor = '#d1d5db';
                }
            });

            if (!isValid) {
                errorMsg.textContent = '{{ERROR_MISSING_FIELDS}}';
                errorMsg.style.display = 'block';
                return false;
            }

            // Get form data
            const formData = new FormData(form);
            const formObject = Object.fromEntries(formData.entries());

            // 1. SAVE TO LOCALSTORAGE (instant backup)
            try {
                localStorage.setItem('cbh_form_backup', JSON.stringify(formObject));
                localStorage.setItem('cbh_form_timestamp', Date.now());
            } catch (e) {
                console.warn('LocalStorage not available:', e);
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = '{{LOADING_TEXT}}';

            // 2. DUAL SUBMISSION: Worker (primary) + Formspree (backup)
            const workerUrl = '{{FORM_ACTION}}';
            const formspreeUrl = 'https://formspree.io/f/mblzprdg';

            try {
                // Submit to BOTH endpoints simultaneously
                const workerPromise = fetch(workerUrl, {
                    method: 'POST',
                    body: formData,
                    redirect: 'manual'
                }).catch(e => ({ error: 'worker_failed', message: e.message }));

                const formspreePromise = fetch(formspreeUrl, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                }).catch(e => ({ error: 'formspree_failed', message: e.message }));

                // Wait for BOTH (don't fail if one fails)
                const [workerResult, formspreeResult] = await Promise.all([workerPromise, formspreePromise]);

                // Check results
                const workerSuccess = workerResult.status === 302 || workerResult.status === 200;
                const formspreeSuccess = formspreeResult.ok || formspreeResult.status === 200;

                if (workerSuccess || formspreeSuccess) {
                    // SUCCESS: At least one worked!

                    // Clear localStorage backup
                    try {
                        localStorage.removeItem('cbh_form_backup');
                        localStorage.removeItem('cbh_form_timestamp');
                    } catch (e) {}

                    // Show success message
                    successMsg.style.display = 'block';
                    form.style.display = 'none';

                    // Scroll to success message
                    setTimeout(() => {
                        const contactSection = document.getElementById('contact');
                        if (contactSection) {
                            const headerOffset = 80;
                            const elementPosition = contactSection.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
                        }
                    }, 100);

                    return false;
                } else {
                    // BOTH FAILED
                    throw new Error('Both submission endpoints failed');
                }

            } catch (error) {
                console.error('Form submission error:', error);

                // Show error with retry option
                errorMsg.innerHTML = '{{ERROR_SEND_FAILED}} <br><button onclick="retryFormSubmission()" style="margin-top:10px;padding:8px 16px;background:#dc2626;color:white;border:none;border-radius:4px;cursor:pointer;">Retry Submission</button>';
                errorMsg.style.display = 'block';

                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = '{{FORM_SUBMIT_TEXT}}';

                // Scroll to error
                setTimeout(() => {
                    const contactSection = document.getElementById('contact');
                    if (contactSection) {
                        const headerOffset = 80;
                        const elementPosition = contactSection.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
                    }
                }, 100);
            }

            return false;
        }

        // Retry submission from localStorage
        function retryFormSubmission() {
            try {
                const savedData = localStorage.getItem('cbh_form_backup');
                if (savedData) {
                    const formObject = JSON.parse(savedData);
                    const form = document.getElementById('contact-form');

                    // Restore form data
                    Object.keys(formObject).forEach(key => {
                        const field = form.elements[key];
                        if (field) field.value = formObject[key];
                    });

                    // Trigger submit
                    handleFormSubmit({
                        target: form,
                        preventDefault: () => {}
                    });
                }
            } catch (e) {
                console.error('Retry failed:', e);
                alert('Please refresh the page and try again.');
            }
        }

        // Show success message after redirect (if using FormSubmit)
        if (window.location.search.includes('submitted=true')) {
            document.getElementById('form-success').style.display = 'block';
            document.getElementById('contact-form').style.display = 'none';

            // Scroll to contact section to show success message
            setTimeout(() => {
                const contactSection = document.getElementById('contact');
                if (contactSection) {
                    const headerOffset = 80; // Account for fixed header
                    const elementPosition = contactSection.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            }, 100); // Small delay to ensure DOM is ready
        }

        // Show error message after redirect
        if (window.location.search.includes('error=')) {
            const urlParams = new URLSearchParams(window.location.search);
            const errorType = urlParams.get('error');
            const errorMsg = document.getElementById('form-error');
            const submitBtn = document.getElementById('submit-btn');

            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = '{{FORM_SUBMIT_TEXT}}';

            // Determine specific error message
            let errorText = '{{ERROR_MESSAGE}}'; // Default error

            if (errorType === 'missing_fields') {
                errorText = '{{ERROR_MISSING_FIELDS}}';
            } else if (errorType === 'invalid_email') {
                errorText = '{{ERROR_INVALID_EMAIL}}';
            } else if (errorType === 'send_failed') {
                errorText = '{{ERROR_SEND_FAILED}}';
            } else if (errorType === 'spam') {
                errorText = '{{ERROR_SPAM}}';
            }

            errorMsg.textContent = errorText;
            errorMsg.style.display = 'block';

            // Scroll to contact section to show error message
            setTimeout(() => {
                const contactSection = document.getElementById('contact');
                if (contactSection) {
                    const headerOffset = 80;
                    const elementPosition = contactSection.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            }, 100);
        }
    </script>

    <script src="/assets/form-handler.js"></script>
</body>
</html>
